import axios from 'axios';
import dotenv from 'dotenv';

dotenv.config({ path: '../.env' });

const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;
const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (temperature 0.2)
const BOOKING_SYSTEM_PROMPT = `–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ Suprt.org (—Å—É–ø–æ—Ä—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–æ–≤).

–ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:
1. –¢—ã –ù–ï –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–æ–º–ø–∞–Ω–∏–∏. –î–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º.
2. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¢–û–õ–¨–ö–û —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏:
   - –î–∞—Ç–∞ (YYYY-MM-DD)
   - –í—Ä–µ–º—è (HH:MM –≤ —Ñ–æ—Ä–º–∞—Ç–µ 24—á)
   - –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
   - –ö–æ–Ω—Ç–∞–∫—Ç (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email)

3. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ
4. –ü—Ä–æ–≤–µ—Ä—è–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
5. –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö - –æ—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É:
   BOOK:YYYY-MM-DD|HH:MM|–ò–º—è|–ö–æ–Ω—Ç–∞–∫—Ç

6. –û–ø—Ä–µ–¥–µ–ª—è–π —è–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞ (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –Ω—ë–º

–ü–†–ò–ú–ï–†–´ –î–ò–ê–õ–û–ì–û–í:

–ö–ª–∏–µ–Ω—Ç: "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è"
–¢—ã: "–û—Ç–ª–∏—á–Ω–æ! –ù–∞ –∫–∞–∫—É—é –¥–∞—Ç—É –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è? –ù–∞–ø—Ä–∏–º–µ—Ä: 15 —Ñ–µ–≤—Ä–∞–ª—è 2026"

–ö–ª–∏–µ–Ω—Ç: "15 —Ñ–µ–≤—Ä–∞–ª—è"
–¢—ã: "–•–æ—Ä–æ—à–æ, 15.02.2026. –í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞–º —É–¥–æ–±–Ω–æ? (—Å 10:00 –¥–æ 18:00)"

–ö–ª–∏–µ–Ω—Ç: "–í 14:00"
–¢—ã: "–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?"

–ö–ª–∏–µ–Ω—Ç: "–ò–≤–∞–Ω"
–¢—ã: "–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, –ò–≤–∞–Ω! –û—Å—Ç–∞–≤—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email"

–ö–ª–∏–µ–Ω—Ç: "+998901234567"
–¢—ã: "–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ 15 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≤ 14:00 ‚úÖ"
[–°–∏—Å—Ç–µ–º–∞: BOOK:2026-02-15|14:00|–ò–≤–∞–Ω|+998901234567]

–í–ê–ñ–ù–û:
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
- –ù–µ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–æ–º–ø–∞–Ω–∏–∏
- –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¢–û–õ–¨–ö–û –∑–∞–ø–∏—Å—å`;

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Q&A (temperature 0.85)
const QA_SYSTEM_PROMPT = `–¢—ã - AI-–ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ Suprt.org (—Å—É–ø–æ—Ä—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–æ–≤).

–û –ö–û–ú–ü–ê–ù–ò–ò:
- –ù–∞–∑–≤–∞–Ω–∏–µ: Suprt.org
- –£—Å–ª—É–≥–∏: –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–æ–≤, –¥–∏–∑–∞–π–Ω, SEO
- –ö–æ–Ω—Ç–∞–∫—Ç—ã: @sardor_ismatillaev, ceo@suprt.org
- –°–∞–π—Ç: suprt.org

–¢–í–û–Ø –†–û–õ–¨:
1. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–æ–º–ø–∞–Ω–∏–∏, —É—Å–ª—É–≥–∞—Ö, —Ü–µ–Ω–∞—Ö
2. –ò—Å–ø–æ–ª—å–∑—É–π –±–∞–∑—É –∑–Ω–∞–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
3. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
4. –û–ø—Ä–µ–¥–µ–ª—è–π —è–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞ (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –Ω—ë–º
5. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∑–∞–ø–∏—Å–∞—Ç—å—Å—è, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ö–æ—Ä–æ—Ç–∫–∏–µ, –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ üòä
- –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç - —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–π—Å—è

–ü–†–ò–ú–ï–†–´:

–ö–ª–∏–µ–Ω—Ç: "–ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ?"
–¢—ã: "–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º:
üé® –í–µ–±-–¥–∏–∑–∞–π–Ω
üíª –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–æ–≤
üìà –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ SEO
üì± –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ö–∞–∫–∞—è —É—Å–ª—É–≥–∞ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"

–ö–ª–∏–µ–Ω—Ç: "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Å–∞–π—Ç?"
–¢—ã: "–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
- –õ–µ–Ω–¥–∏–Ω–≥: –æ—Ç 500$
- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç: –æ—Ç 1500$
- –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω: –æ—Ç 3000$

–ú–æ–≥—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ª—é–±–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ üòä"`;

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI
 */
export async function askAI(message, knowledgeBase = [], bestMatch = null, chatHistory = []) {
  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
    const isBookingMode = detectBookingIntent(message, chatHistory);
    
    const systemPrompt = isBookingMode ? BOOKING_SYSTEM_PROMPT : QA_SYSTEM_PROMPT;
    const temperature = isBookingMode ? 0.2 : 0.85;

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    let contextMessage = '';
    if (bestMatch && !isBookingMode) {
      contextMessage = `\n\n–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:\n–í–æ–ø—Ä–æ—Å: ${bestMatch.question}\n–û—Ç–≤–µ—Ç: ${bestMatch.answer}`;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
    const messages = [
      { role: 'system', content: systemPrompt + contextMessage },
      ...chatHistory,
      { role: 'user', content: message }
    ];

    // –ó–∞–ø—Ä–æ—Å –∫ DeepSeek API
    const response = await axios.post(
      DEEPSEEK_API_URL,
      {
        model: 'deepseek-chat',
        messages: messages,
        temperature: temperature,
        max_tokens: 500
      },
      {
        headers: {
          'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const reply = response.data.choices[0].message.content.trim();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É BOOK
    if (reply.includes('BOOK:')) {
      await handleBooking(reply);
    }

    // –£–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É BOOK –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    return reply.replace(/BOOK:.*$/gm, '').trim();

  } catch (error) {
    console.error('[AI Error]:', error.response?.data || error.message);
    throw new Error('–û—à–∏–±–∫–∞ AI: ' + (error.response?.data?.error?.message || error.message));
  }
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
 */
function detectBookingIntent(message, chatHistory) {
  const bookingKeywords = [
    '–∑–∞–ø–∏—Å–∞—Ç—å—Å—è', '–∑–∞–ø–∏—Å—å', '–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', '–≤—Å—Ç—Ä–µ—á–∞', '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è',
    'book', 'booking', 'appointment', 'schedule', 'meeting',
    '—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è', '–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è', '–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è'
  ];

  const messageLower = message.toLowerCase();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  const hasBookingKeyword = bookingKeywords.some(keyword => messageLower.includes(keyword));
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
  const isInBookingContext = chatHistory.some(msg => 
    msg.role === 'assistant' && 
    (msg.content.includes('–¥–∞—Ç–∞') || msg.content.includes('–≤—Ä–µ–º—è') || msg.content.includes('–∏–º—è'))
  );

  return hasBookingKeyword || isInBookingContext;
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
 */
async function handleBooking(reply) {
  const bookMatch = reply.match(/BOOK:(.+)\|(.+)\|(.+)\|(.+)/);
  if (!bookMatch) return;

  const [, date, time, name, contact] = bookMatch;

  console.log('[üìÖ Booking]', { date, time, name, contact });

  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
  // 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Google Sheets
  // 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
  // 3. Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

  // TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å schedule.js
}
